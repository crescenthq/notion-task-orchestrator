#!/usr/bin/env bash
set -euo pipefail

case "${AGENT_ACTION:-}" in
  describe)
    echo "name: shell"
    echo "description: Execute prompt as shell command"
    echo "timeout: 120"
    echo "retries: 0"
    ;;
  execute)
    INPUT=$(cat)
    PROMPT=$(echo "$INPUT" | node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{const j=JSON.parse(d);process.stdout.write(j.prompt||"")})')
    WORKDIR=$(echo "$INPUT" | node -e 'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>{const j=JSON.parse(d);process.stdout.write(j.workdir||".")})')
    cd "$WORKDIR"
    bash -lc "$PROMPT"
    ;;
  *)
    echo "Unknown AGENT_ACTION: ${AGENT_ACTION:-}" >&2
    exit 1
    ;;
esac
