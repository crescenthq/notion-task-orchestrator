2026-02-27 — TSK-001: CLI reduction and factory-first naming
- Added new top-level `factory` command group with `install`, `create`, and `list` in `src/commands/factory.ts`.
- Removed top-level `executor` and `workflow` command groups from CLI registration in `src/cli.ts`.
- Updated user-facing command/help text to use `factory` terminology in `setup`, `run`, `tick`, and Notion integration command args (`--factory`).
- Rewrote README command examples around `factory` operations.
- Verified with `npm run check` and `npx tsx src/cli.ts factory --help`.

2026-02-27 — TSK-002: Factory definition loader (TypeScript modules)
- Added `src/core/factorySchema.ts` with TypeScript factory schema validation for state-machine definitions (`action`, `orchestrate`, `loop`, `feedback`, terminal states) and unified `on` transition-map checks.
- Added `src/core/factory.ts` loader to import factory modules from file paths, validate `export default` factory objects at load time, and emit actionable diagnostics.
- Enforced runtime function locality checks in loader: imported identifiers cannot be used for runtime hooks (`agent`, `select`, `until`), rejecting cross-file runtime function references.
- Updated `src/commands/factory.ts` to install TS factory modules, scaffold `.ts` factories, and persist a serialized factory snapshot in the local DB.
- Added tests in `src/core/factorySchema.test.ts` and `src/core/factory.test.ts` for transition validation, loop-guard validation, loader behavior, and imported-function rejection.
- Updated `src/cli.test.ts` bootstrap assertion to use `factory list` command surface.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-003: State-machine runtime core
- Added `src/core/factoryRuntime.ts` and replaced linear step execution with a factory state-machine engine that executes `action` and `orchestrate` states via emitted events resolved through each state's `on` map.
- Updated `src/commands/run.ts` to delegate task execution to the new runtime (`runFactoryTaskByExternalId`).
- Added transition journaling schema in `src/db/schema.ts` (`transition_events`) and bootstrap SQL in `src/db/bootstrap.ts`; each transition now records `runId`, `tickId`, `fromStateId`, `toStateId`, `event`, `reason`, `attempt`, `loopIteration`, and timestamp.
- Added run persistence support fields (`runs.current_state_id`, `runs.context_json`) in schema for state/context snapshot compatibility and kept task-level persisted context in `tasks.step_vars_json` for crash-safe resume.
- Updated `src/commands/board.ts` cleanup to delete transition event rows when removing a board.
- Added `src/core/factoryRuntime.test.ts` covering (1) sequence + conditional orchestration to terminal `done`, and (2) persisted feedback pause/resume from stored state/context.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-004: Retry and failure policy engine
- Updated `src/core/factorySchema.ts` retry config to support canonical `retries.max` plus optional `backoff` strategy, while keeping `maxRetries` as a compatibility alias.
- Added schema validation/tests in `src/core/factorySchema.test.ts` for valid `retries.max` + backoff and invalid retry configs missing max semantics.
- Implemented action retry execution in `src/core/factoryRuntime.ts` with per-state persisted attempt counters (`__nf_retry_attempts`) in run context.
- Added retry backoff handling (`fixed`/`exponential`) and Notion/local retry logging for failed attempts prior to exhaustion.
- Routed exhausted retries via configured `on.failed` target with transition reason `action.failed.exhausted`, persisted `last_error`, and transition-event attempt metadata.
- Added runtime tests in `src/core/factoryRuntime.test.ts` for (1) retry-then-success path and (2) retry exhaustion to failure target.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-005: Feedback (human-in-the-loop) pause/resume
- Implemented `feedback.resume` runtime behavior in `src/core/factoryRuntime.ts`: pause now persists a computed resume target that defaults to previous state and honors explicit override state IDs.
- Updated feedback requeue handling in `src/commands/notion.ts` to clear `waitingSince` on resume enqueue, update Notion state back to `Queue`, and append a Notion log callout for feedback-received resume events.
- Added runtime regression coverage in `src/core/factoryRuntime.test.ts` for explicit feedback resume override (`resume: "<stateId>"`) to verify resume starts from override target.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-006: Loop orchestration (v1 bounded)
- Implemented runtime `loop` state execution in `src/core/factoryRuntime.ts` with deterministic `continue`, `done`, and `exhausted` event emission routed through the loop state's `on` map.
- Added persisted loop counter context (`__nf_loop_iterations`) keyed by loop state ID so iteration progress survives pauses/restarts and is available to guards.
- Added loop-aware transition journaling: `transition_events.loop_iteration` now records the loop iteration index for loop transitions.
- Extended `src/core/factorySchema.ts` loop validation to require `on.continue`, `on.done`, and `on.exhausted`, and enforce `on.continue` targets the loop `body`.
- Added coverage in `src/core/factoryRuntime.test.ts` for (1) loop exit via `done` guard and (2) loop exit via `exhausted` max-iteration cap; added schema validation coverage in `src/core/factorySchema.test.ts`.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-007: Inline agent contract
- Tightened action-state contract validation in `src/core/factorySchema.ts` to require explicit `on.done` and `on.failed` transition routes for all `action` states.
- Hardened runtime output validation in `src/core/factoryRuntime.ts` for action agents: enforced `status` enum (`done|feedback|failed`) and strict optional field types (`data` must be object, `message` must be string when provided) before transition routing.
- Added regression coverage in `src/core/factorySchema.test.ts` and `src/core/factoryRuntime.test.ts` for missing action failure route and invalid action agent outputs (`status` and `data` shape violations).
- Updated `README.md` factory documentation to use TypeScript module install examples and documented the inline action agent return contract.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-010: Tick budget + worker lease safety
- Added runtime execution options in `src/core/factoryRuntime.ts` (`maxTransitionsPerTick`, `leaseMs`, `leaseMode`, `workerId`) with sane defaults and strict option normalization.
- Replaced terminal failure on per-tick budget with resumable pause behavior: runtime now persists task/run snapshot and exits cleanly when transition budget is reached so subsequent ticks can continue from persisted state.
- Implemented run-level lease acquisition + heartbeat/renewal in runtime with strict compare-and-set semantics on `runs` lease fields; strict mode rejects execution when another worker holds an unexpired lease, while best-effort mode skips.
- Added and persisted run lease fields (`lease_owner`, `lease_expires_at`, `lease_heartbeat_at`) in `src/db/schema.ts` and `src/db/bootstrap.ts`, including bootstrap-time column backfill for existing databases.
- Wired tick/run CLI plumbing to pass budget and lease controls: updated `src/commands/tick.ts`, `src/commands/run.ts`, and `src/commands/notion.ts`.
- Added runtime regression tests in `src/core/factoryRuntime.test.ts` for (1) bounded tick pause/resume across multiple ticks and (2) strict lease rejection under active competing lease.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-008: End-to-end live Notion verification suite
- Added deterministic TypeScript live-verification factory fixtures in `tasks/factories/` for happy path, feedback pause/resume, retry/failure, bounded loop, and budgeted resume/replay scenarios.
- Added `tasks/scripts/run-factory-verification.ts` to automate live Notion verification: installs fixture factories, creates scenario tasks, executes runtime via CLI, validates expected outcomes, and writes timestamped verification artifacts.
- Added deterministic replay consistency validation against `transition_events` in the runner, including feedback-resume discontinuity handling and strict required-field checks.
- Updated `tasks/factory-agent-verification.md` with fixture inventory, automated runner usage, feedback-mode controls, artifact location, and refreshed scenario expectation/observation template.
- Ran live verification with configured Notion credentials; all scenarios passed and produced artifact `tasks/artifacts/factory-live-verification-20260227-015834.json`.
