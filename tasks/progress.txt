2026-02-27 — TSK-001: CLI reduction and factory-first naming
- Added new top-level `factory` command group with `install`, `create`, and `list` in `src/commands/factory.ts`.
- Removed top-level `executor` and `workflow` command groups from CLI registration in `src/cli.ts`.
- Updated user-facing command/help text to use `factory` terminology in `setup`, `run`, `tick`, and Notion integration command args (`--factory`).
- Rewrote README command examples around `factory` operations.
- Verified with `npm run check` and `npx tsx src/cli.ts factory --help`.

2026-02-27 — TSK-002: Factory definition loader (TypeScript modules)
- Added `src/core/factorySchema.ts` with TypeScript factory schema validation for state-machine definitions (`action`, `orchestrate`, `loop`, `feedback`, terminal states) and unified `on` transition-map checks.
- Added `src/core/factory.ts` loader to import factory modules from file paths, validate `export default` factory objects at load time, and emit actionable diagnostics.
- Enforced runtime function locality checks in loader: imported identifiers cannot be used for runtime hooks (`agent`, `select`, `until`), rejecting cross-file runtime function references.
- Updated `src/commands/factory.ts` to install TS factory modules, scaffold `.ts` factories, and persist a serialized factory snapshot in the local DB.
- Added tests in `src/core/factorySchema.test.ts` and `src/core/factory.test.ts` for transition validation, loop-guard validation, loader behavior, and imported-function rejection.
- Updated `src/cli.test.ts` bootstrap assertion to use `factory list` command surface.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-003: State-machine runtime core
- Added `src/core/factoryRuntime.ts` and replaced linear step execution with a factory state-machine engine that executes `action` and `orchestrate` states via emitted events resolved through each state's `on` map.
- Updated `src/commands/run.ts` to delegate task execution to the new runtime (`runFactoryTaskByExternalId`).
- Added transition journaling schema in `src/db/schema.ts` (`transition_events`) and bootstrap SQL in `src/db/bootstrap.ts`; each transition now records `runId`, `tickId`, `fromStateId`, `toStateId`, `event`, `reason`, `attempt`, `loopIteration`, and timestamp.
- Added run persistence support fields (`runs.current_state_id`, `runs.context_json`) in schema for state/context snapshot compatibility and kept task-level persisted context in `tasks.step_vars_json` for crash-safe resume.
- Updated `src/commands/board.ts` cleanup to delete transition event rows when removing a board.
- Added `src/core/factoryRuntime.test.ts` covering (1) sequence + conditional orchestration to terminal `done`, and (2) persisted feedback pause/resume from stored state/context.
- Verified with `npm run check` and `npm test`.

2026-02-27 — TSK-004: Retry and failure policy engine
- Updated `src/core/factorySchema.ts` retry config to support canonical `retries.max` plus optional `backoff` strategy, while keeping `maxRetries` as a compatibility alias.
- Added schema validation/tests in `src/core/factorySchema.test.ts` for valid `retries.max` + backoff and invalid retry configs missing max semantics.
- Implemented action retry execution in `src/core/factoryRuntime.ts` with per-state persisted attempt counters (`__nf_retry_attempts`) in run context.
- Added retry backoff handling (`fixed`/`exponential`) and Notion/local retry logging for failed attempts prior to exhaustion.
- Routed exhausted retries via configured `on.failed` target with transition reason `action.failed.exhausted`, persisted `last_error`, and transition-event attempt metadata.
- Added runtime tests in `src/core/factoryRuntime.test.ts` for (1) retry-then-success path and (2) retry exhaustion to failure target.
- Verified with `npm run check` and `npm test`.
