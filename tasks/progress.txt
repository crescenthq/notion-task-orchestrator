## Completed Tasks

### 2026-02-27 â€” US-001 + US-002 partial: src/services/notion.ts (commit d9d00d4)
- STATE_OPTIONS: replaced { name: "Waiting", color: "yellow" } with { name: "Feedback", color: "purple" }
- mapTaskStateToNotionStatus(): removed waitingâ†’Waiting, added feedbackâ†’Feedback
- inferCalloutEmoji(): "feedback needed" now returns ðŸ’¬ (was ðŸ¤”)
- Added notionPostComment(token, pageId, text) â€” POST /v1/comments
- Added notionGetNewComments(token, pageId, since) â€” filters notionListComments by timestamp

### 2026-02-27 â€” US-001 + US-002: src/commands/run.ts + src/core/workflow.ts (commit 684fe78)
- parseStatusDirective(): replaced "waiting" with "feedback" in regex and return type
- Replaced STATUS: waiting block with STATUS: feedback block: extracts QUESTION: key, posts Notion comment via notionPostComment(), sets state="feedback", stores stepVarsJson + waitingSince
- Simplified resume path: reads human_feedback from restored stepVarsJson (pre-injected by tick sync), removes notionGetNewPageBodyText call
- Removed notionGetNewPageBodyText from import (no longer needed in run.ts)

### 2026-02-27 â€” US-003: src/commands/notion.ts (commit 4adf7dd)
- Added notionGetNewComments to import from ../services/notion
- Added feedback auto-resume loop inside the board sync loop (after each board's main try/catch)
- Queries DB for tasks in `feedback` state per board, checks for new Notion comments since `waitingSince`
- Injects `human_feedback` into `stepVarsJson` and sets state to `queued` so tick picks them up
- If `runQueued` is true, also adds re-queued tasks to `queuedTaskIds` for immediate execution

### 2026-02-27 â€” Verification: fix failing tests (commit d0f38db)
- notion.test.ts local STATE_OPTIONS had stale { name: "Waiting", color: "yellow" } â€” updated to { name: "Feedback", color: "purple" }
- npm run check: passes (no TypeScript errors)
- npm test: all 17 tests pass (5 test files)

### 2026-02-27 â€” E2E tracer bullet + sync bug fix (commit 236c7c7)
- Added workflows/feedback-test.yaml: two-step shell workflow (ask â†’ confirm) to exercise the full feedback loop
- Bug found and fixed: upsertTask in notion.ts was clobbering 'feedback' DB state with stale 'In Progress' from Notion on every sync, causing the feedback auto-resume loop to find zero tasks
- Fix: use SQL CASE to preserve agent-managed states ('feedback', 'running') during sync upsert
- E2E verified with live Notion API (code-factory board):
  1. bun run dev -- run --task <id>  â†’ step ask output STATUS: feedback, question extracted, comment posted to Notion, DB state = feedback
  2. Human reply posted via Notion API
  3. bun run dev -- tick --run  â†’ comment detected (newer than waitingSince), human_feedback injected, task re-queued, confirm step ran, task state = done
  4. Log: "Resuming with human feedback (26 chars)" confirmed human_feedback was available in step prompt

## Status
All PRD tasks complete including E2E verification. No remaining tasks.
